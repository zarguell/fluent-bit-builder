name: Build Static Fluent Bit 4.2.0 for OpenWRT

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: x86_64
            platform: linux/amd64
          - arch: arm_cortex-a7
            platform: linux/arm/v7
          - arch: aarch64_cortex-a53
            platform: linux/arm64
    
    steps:
      - name: Checkout Fluent Bit
        uses: actions/checkout@v4
        with:
          repository: fluent/fluent-bit
          ref: v4.2.0
          submodules: recursive
          
      - name: Set up QEMU for cross-compilation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all
          
      - name: Build Static Fluent Bit
        run: |
          mkdir -p output
          
          docker run --rm \
            --platform ${{ matrix.platform }} \
            -v "$(pwd):/src" \
            -v "$(pwd)/output:/output" \
            -w /src \
            alpine:latest \
            sh -c '
              set -e
              
              echo "=== Installing build dependencies ==="
              apk add --no-cache \
                build-base \
                cmake \
                flex \
                bison \
                linux-headers \
                openssl-dev \
                openssl-libs-static \
                zlib-dev \
                zlib-static \
                yaml-dev \
                yaml-static \
                musl-fts-dev \
                git \
                file
              
              echo "=== System info ==="
              uname -m
              gcc --version
              
              echo "=== Configuring Fluent Bit ==="
              mkdir -p /src/build && cd /src/build
              
              cmake \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_INSTALL_PREFIX=/usr \
                -DCMAKE_C_FLAGS="-static" \
                -DCMAKE_EXE_LINKER_FLAGS="-static" \
                -DCMAKE_FIND_LIBRARY_SUFFIXES=".a" \
                -DBUILD_SHARED_LIBS=OFF \
                -DOPENSSL_USE_STATIC_LIBS=TRUE \
                -DOPENSSL_ROOT_DIR=/usr \
                -DOPENSSL_CRYPTO_LIBRARY=/usr/lib/libcrypto.a \
                -DOPENSSL_SSL_LIBRARY=/usr/lib/libssl.a \
                -DZLIB_LIBRARY=/usr/lib/libz.a \
                -DFLB_RELEASE=On \
                -DFLB_STATIC_BINARY=On \
                -DFLB_SHARED_LIB=Off \
                -DFLB_OUT_HTTP=On \
                -DFLB_OUT_KAFKA=On \
                -DFLB_IN_TAIL=On \
                -DFLB_IN_SYSLOG=On \
                -DFLB_IN_CPU=On \
                -DFLB_IN_MEM=On \
                -DFLB_IN_DISK=On \
                -DFLB_OUT_FORWARD=On \
                -DFLB_OUT_STDOUT=On \
                -DFLB_OUT_FILE=On \
                -DFLB_OUT_NULL=On \
                -DFLB_OUT_ES=On \
                -DFLB_FILTER_GREP=On \
                -DFLB_FILTER_MODIFY=On \
                -DFLB_FILTER_KUBERNETES=On \
                -DFLB_FILTER_REWRITE_TAG=On \
                -DFLB_FILTER_THROTTLE=On \
                -DFLB_TLS=On \
                -DFLB_REGEX=On \
                -DFLB_PARSER=On \
                -DFLB_JEMALLOC=Off \
                -DFLB_BACKTRACE=Off \
                -DFLB_LUAJIT=Off \
                -DFLB_STREAM_PROCESSOR=Off \
                -DFLB_EXAMPLES=Off \
                -DFLB_TESTS=Off \
                ..
              
              echo "=== Building ==="
              make -j$(nproc) VERBOSE=1 2>&1 | tee build.log || true
              
              # If build failed, try adding fts library manually
              if [ ! -f bin/fluent-bit ]; then
                echo "=== First build failed, retrying with explicit fts linking ==="
                
                # Find the failing link command and add -lfts
                cd /src/build/src
                /usr/bin/c++ -static -rdynamic CMakeFiles/fluent-bit-bin.dir/fluent-bit.c.o CMakeFiles/fluent-bit-bin.dir/flb_dump.c.o -o ../bin/fluent-bit \
                  -Wl,--whole-archive \
                  ../library/*.a \
                  -Wl,--no-whole-archive \
                  -lfts -lpthread -lm -ldl || echo "Manual link attempt failed"
                  
                cd /src/build
              fi
              
              if [ -f bin/fluent-bit ]; then
                echo "=== Stripping binary ==="
                strip bin/fluent-bit
                
                echo "=== Binary info ==="
                ls -lh bin/fluent-bit
                file bin/fluent-bit
                ldd bin/fluent-bit 2>&1 || echo "✓ Static binary (expected)"
                
                echo "=== Testing binary ==="
                ./bin/fluent-bit --version
                
                cp bin/fluent-bit /output/fluent-bit-${{ matrix.arch }}
                echo "✓ Build successful for ${{ matrix.arch }}"
              else
                echo "✗ Build failed - binary not found"
                tail -100 build.log
                exit 1
              fi
            '
            
      - name: Verify Static Binary
        run: |
          if [ -f "output/fluent-bit-${{ matrix.arch }}" ]; then
            echo "✓ Binary created: fluent-bit-${{ matrix.arch }}"
            ls -lh output/fluent-bit-${{ matrix.arch }}
            file output/fluent-bit-${{ matrix.arch }}
          else
            echo "✗ Binary not found"
            exit 1
          fi
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: fluent-bit-${{ matrix.arch }}
          path: output/fluent-bit-${{ matrix.arch }}
          retention-days: 30
          
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: binaries
          
      - name: Prepare release
        run: |
          mkdir -p release
          find binaries -type f -name "fluent-bit-*" -exec cp {} release/ \;
          cd release
          sha256sum fluent-bit-* > SHA256SUMS
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Fluent Bit ${{ github.ref_name }} for OpenWRT 24.10
          body: |
            # Fluent Bit 4.2.0 for OpenWRT 24.10
            
            Fully static binaries with complete OpenSSL support.
            
            ## Architectures
            
            - **fluent-bit-x86_64** - Intel/AMD
            - **fluent-bit-arm_cortex-a7** - ARM v7
            - **fluent-bit-aarch64_cortex-a53** - ARM64
            
            ## Installation
            
            ```
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/fluent-bit-ARCH
            chmod +x fluent-bit-ARCH
            mv fluent-bit-ARCH /usr/bin/fluent-bit
            fluent-bit --version
            ```
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
