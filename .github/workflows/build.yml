name: Build Static Fluent Bit 4.2.0 for OpenWRT

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: x86_64
            platform: linux/amd64
          - arch: arm_cortex-a7
            platform: linux/arm/v7
          - arch: aarch64_cortex-a53
            platform: linux/arm64
    
    steps:
      - name: Checkout Fluent Bit
        uses: actions/checkout@v4
        with:
          repository: fluent/fluent-bit
          ref: v4.2.0
          submodules: recursive
          
      - name: Set up QEMU for cross-compilation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all
          
      - name: Build Static Fluent Bit
        run: |
          mkdir -p output
          
          docker run --rm \
            --platform ${{ matrix.platform }} \
            -v "$(pwd):/src" \
            -v "$(pwd)/output:/output" \
            -w /src \
            alpine:latest \
            sh -c '
              set -e
              
              echo "=== Installing build dependencies ==="
              apk add --no-cache \
                build-base \
                cmake \
                flex \
                bison \
                linux-headers \
                openssl-dev \
                openssl-libs-static \
                zlib-dev \
                zlib-static \
                yaml-dev \
                yaml-static \
                git \
                file
              
              echo "=== System info ==="
              uname -m
              gcc --version
              
              echo "=== Configuring Fluent Bit ==="
              mkdir -p /src/build && cd /src/build
              
              cmake \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_INSTALL_PREFIX=/usr \
                -DCMAKE_C_FLAGS="-static" \
                -DCMAKE_EXE_LINKER_FLAGS="-static" \
                -DFLB_RELEASE=On \
                -DFLB_STATIC_BINARY=On \
                -DFLB_SHARED_LIB=Off \
                -DFLB_OUT_HTTP=On \
                -DFLB_OUT_KAFKA=On \
                -DFLB_IN_TAIL=On \
                -DFLB_IN_SYSLOG=On \
                -DFLB_IN_CPU=On \
                -DFLB_IN_MEM=On \
                -DFLB_IN_DISK=On \
                -DFLB_OUT_FORWARD=On \
                -DFLB_OUT_STDOUT=On \
                -DFLB_OUT_FILE=On \
                -DFLB_OUT_NULL=On \
                -DFLB_OUT_ES=On \
                -DFLB_FILTER_GREP=On \
                -DFLB_FILTER_MODIFY=On \
                -DFLB_FILTER_KUBERNETES=On \
                -DFLB_FILTER_REWRITE_TAG=On \
                -DFLB_FILTER_THROTTLE=On \
                -DFLB_TLS=On \
                -DFLB_REGEX=On \
                -DFLB_PARSER=On \
                -DFLB_JEMALLOC=Off \
                -DFLB_BACKTRACE=Off \
                -DFLB_LUAJIT=Off \
                -DFLB_STREAM_PROCESSOR=Off \
                -DFLB_EXAMPLES=Off \
                -DFLB_TESTS=Off \
                ..
              
              echo "=== Building (this takes ~10-15 minutes) ==="
              make -j$(nproc) 2>&1 | tee build.log || true
              
              if [ -f bin/fluent-bit ]; then
                echo "=== Stripping binary ==="
                strip bin/fluent-bit
                
                echo "=== Binary info ==="
                ls -lh bin/fluent-bit
                file bin/fluent-bit
                ldd bin/fluent-bit 2>&1 || echo "✓ Static binary"
                
                echo "=== Testing binary ==="
                ./bin/fluent-bit --version
                
                cp bin/fluent-bit /output/fluent-bit-${{ matrix.arch }}
                echo "✓ Build successful for ${{ matrix.arch }}"
              else
                echo "✗ Build failed"
                tail -200 build.log
                exit 1
              fi
            '
            
      - name: Verify Static Binary
        run: |
          if [ -f "output/fluent-bit-${{ matrix.arch }}" ]; then
            echo "✓ Binary created: fluent-bit-${{ matrix.arch }}"
            ls -lh output/fluent-bit-${{ matrix.arch }}
            file output/fluent-bit-${{ matrix.arch }}
          else
            echo "✗ Binary not found"
            exit 1
          fi
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: fluent-bit-${{ matrix.arch }}
          path: output/fluent-bit-${{ matrix.arch }}
          retention-days: 30
          
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: binaries
          
      - name: Prepare release
        run: |
          mkdir -p release
          find binaries -type f -name "fluent-bit-*" -exec cp {} release/ \;
          cd release
          sha256sum fluent-bit-* > SHA256SUMS
          cat SHA256SUMS
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Fluent Bit ${{ github.ref_name }} for OpenWRT 24.10
          body: |
            # Fluent Bit 4.2.0 for OpenWRT 24.10 (Static Builds)
            
            Fully static binaries with complete OpenSSL support - zero dependencies.
            
            ## Architectures
            
            | Binary | Compatible Devices |
            |--------|-------------------|
            | **fluent-bit-x86_64** | Intel/AMD routers (PC Engines APU, x86 devices) |
            | **fluent-bit-arm_cortex-a7** | ARM v7 (Raspberry Pi 2, older ARM routers, many consumer routers) |
            | **fluent-bit-aarch64_cortex-a53** | ARM64 (Raspberry Pi 3/4, modern routers) |
            
            ## Features
            
            **✅ Complete Feature Set**
            - **Inputs:** tail, syslog, cpu, mem, disk
            - **Outputs:** http, kafka, elasticsearch, forward, stdout, file, null
            - **Filters:** grep, modify, kubernetes, rewrite_tag, throttle
            - **Full OpenSSL support:** TLS 1.2/1.3, HTTPS, Kafka SSL/SASL
            - **Compression:** zlib, zstd
            - **Parsing:** regex, custom parsers
            
            **✅ Static Compilation**
            - Zero dependencies - runs on any musl system
            - Single binary - no libraries needed
            - Drop-in ready for OpenWRT
            
            ## Installation
            
            ### Detect Architecture
            ```
            uname -m
            # x86_64 → use fluent-bit-x86_64
            # armv7l → use fluent-bit-arm_cortex-a7
            # aarch64 → use fluent-bit-aarch64_cortex-a53
            ```
            
            ### Install
            ```
            # Download for your architecture
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/fluent-bit-ARCH
            
            # Verify checksum
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/SHA256SUMS
            sha256sum -c SHA256SUMS 2>&1 | grep fluent-bit-ARCH
            
            # Install
            chmod +x fluent-bit-ARCH
            mv fluent-bit-ARCH /usr/bin/fluent-bit
            
            # Verify
            fluent-bit --version
            ```
            
            ## Configuration Examples
            
            ### HTTPS Output
            ```
            [SERVICE]
                Flush        5
                Daemon       off
            
            [INPUT]
                Name         tail
                Path         /var/log/messages
                Tag          syslog
                
            [OUTPUT]
                Name         http
                Match        *
                Host         logs.example.com
                Port         443
                URI          /api/logs
                Format       json
                tls          on
                tls.verify   on
            ```
            
            ### Kafka with SASL Authentication
            ```
            [OUTPUT]
                Name                          kafka
                Match                         *
                Brokers                       kafka.example.com:9093
                Topics                        application-logs
                rdkafka.security.protocol     SASL_SSL
                rdkafka.sasl.mechanism        PLAIN
                rdkafka.sasl.username         your-username
                rdkafka.sasl.password         your-password
                rdkafka.compression.type      zstd
            ```
            
            ### Elasticsearch
            ```
            [OUTPUT]
                Name         es
                Match        *
                Host         elasticsearch.example.com
                Port         9200
                Index        logs
                Type         _doc
                tls          on
                tls.verify   off
            ```
            
            ## What's New in 4.2.0
            
            - Enhanced routing and data flow control
            - Improved metrics and observability
            - Performance optimizations
            - Stability improvements
            
            See https://fluentbit.io/announcements/v4.2.0/ for full release notes.
            
            ## Checksums
            
            See `SHA256SUMS` file for SHA-256 verification hashes.
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
